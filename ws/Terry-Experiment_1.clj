;; gorilla-repl.fileformat = 1

;; **
;;; # Algebolic/SPEA2 Experiment2
;;; 
;;; How does the size of the archive effects the mean error of the elites 
;; **

;; @@
(ns terry-experiment2
    (:require [gorilla-plot.core :as plot]
            [algebolic.expression.core :as expression]
            [algebolic.expression.tree :as tree]
            [algebolic.expression.genetics :as genetics]
            [algebolic.expression.score :as score]
            [algebolic.expression.render :as render]
            [algebolic.expression.interpreter :as interpreter]
            [darwin.evolution.core :as evolution]
            [darwin.evolution.metrics :as metrics]
            [darwin.evolution.reproduction :as reproduction]
            [darwin.evolution.scoring :as scoring]
            [darwin.evolution.selection :as selection]
            [darwin.evolution.transform :as transform]
            [darwin.evolution.pareto :as pareto]
            [darwin.algorithms.spea2 :as spea2]
            [criterium.core :as criterium]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; Have a single cycle of a sine wave. Use the functions and terminals from Algebolic.
;; **

;; @@
(def xs (range 0.0 6.28 0.1))
(def coords (mapv (fn [x] [x]) xs))
(def data (map (fn [x] (Math/sin x)) xs))
(def vars '[x])
(def functions (expression/get-functions #{:plus :minus :times :div}))
(def terminals (expression/terminal-generators vars))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;terry-experiment2/terminals</span>","value":"#'terry-experiment2/terminals"}
;; <=

;; **
;;; Use the initial-zeitgeist function from Darwin, but construct a function archive-gc that creates a configuration map which can be parameterised by archive size. Keep all of the transformations in  from the Darwin file such as Hill descent - why not!
;; **

;; @@
;create the initial population - or zeitgeist
(def initial-zeitgeist
(evolution/make-zeitgeist (genetics/full-population functions terminals 50 7)))
;define a mean function in order to find the mean errors
(defn mean 
  [data]
  (let [num (count data)]
  (/ (apply + data) num )
    ))
;this function runs the spea2 for the same initial-zeitgeist but can be parameterised by archive-size
(defn archive-gc
  [archive-size]
  (let [size-limit 80
        min-size 15
        ea-config (spea2/spea2-config
                    {:goals [:error :complexity]
                     :archive-size archive-size
                     :binary-ops [{:op (partial genetics/ninety-ten-sl-crossover size-limit) :repeat 23}]
                     :unary-ops [{:op (partial genetics/random-tree-mutation functions terminals 3) :repeat 4}]})
        score-functions {:complexity tree/count-nodes
                         :error (fn [ex] (score/abs-error vars coords data ex))}
        gc	{:ea-config              ea-config
     			:transformations        [(partial transform/apply-to-fraction-of-genotypes
                                       (partial transform/hill-descent
                                                genetics/twiddle-constants
                                                (:error score-functions))
                                       0.5)
                              (partial transform/apply-to-all-genotypes
                                       (partial genetics/trim-hard size-limit))
                              (partial transform/apply-to-all-genotypes
                                       (partial genetics/boost-hard min-size
                                                #(genetics/random-full-tree functions terminals 3)))]
     		:score-functions        score-functions
     		:reporting-function     (fn [z] (print ".") (flush))}
        ]
     (mean (map :error (:elite (evolution/run-evolution gc initial-zeitgeist (fn [zg gc] (>= (:age zg) 100))))))
    )
  )
;
;
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;terry-experiment2/archive-gc</span>","value":"#'terry-experiment2/archive-gc"}
;; <=

;; **
;;; Now choose random archive sizes from 1 to 98 and find the mean errors then plot.
;; **

;; @@


;choose archive values uniformly distributed between 1 and 98
(def archive-vals (repeatedly 80 #(+ 1 (rand-int 98))))
;perform the evolutions from the same initial zeitgeist and find the mean errors of the elites
(def error-means (doall (map archive-gc archive-vals)))
;plot the results
(plot/list-plot (mapv #(vector %1 %2) archive-vals error-means))
;
;
;
;as can be seen there is no significant correlation







;; @@
;; ->
;;; ................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
;; <-
;; =>
;;; {"type":"vega","content":{"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"b0822090-f487-4c21-9383-37338f5835e0","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"b0822090-f487-4c21-9383-37338f5835e0","field":"data.y"}}],"marks":[{"type":"symbol","from":{"data":"b0822090-f487-4c21-9383-37338f5835e0"},"properties":{"enter":{"x":{"field":"data.x","scale":"x"},"y":{"field":"data.y","scale":"y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}}],"data":[{"name":"b0822090-f487-4c21-9383-37338f5835e0","values":[{"x":25,"y":25.046187131967198},{"x":26,"y":19.177480607460254},{"x":60,"y":22.020183085175287},{"x":68,"y":23.542881758987544},{"x":77,"y":29.873773905092996},{"x":40,"y":29.435168900590526},{"x":52,"y":17.85466689923243},{"x":62,"y":20.57385469398166},{"x":55,"y":19.565803502681632},{"x":33,"y":15.194638284415097},{"x":71,"y":24.944867408723194},{"x":1,"y":24.301955126840575},{"x":43,"y":28.330625447682593},{"x":60,"y":24.6125727118996},{"x":57,"y":29.752424136964425},{"x":62,"y":40.86703453767188},{"x":49,"y":18.954004448695944},{"x":70,"y":26.705362612506658},{"x":51,"y":31.946951235030465},{"x":8,"y":24.66512520792789},{"x":16,"y":26.71588338988585},{"x":58,"y":38.08841008989284},{"x":1,"y":24.430473122357625},{"x":1,"y":24.420236235714043},{"x":94,"y":27.164164427843232},{"x":76,"y":28.526375709964668},{"x":77,"y":17.364629230226566},{"x":81,"y":30.06513564247807},{"x":28,"y":21.740602435009855},{"x":43,"y":21.139116580288277},{"x":40,"y":31.914848995951683},{"x":53,"y":27.336344401066096},{"x":17,"y":17.89677529711414},{"x":61,"y":34.109102985715346},{"x":62,"y":70.73389176539517},{"x":53,"y":18.63235669745532},{"x":16,"y":19.097877660659936},{"x":30,"y":16.59110416336605},{"x":40,"y":25.81523196463841},{"x":83,"y":32.079240710585914},{"x":27,"y":21.89898523202033},{"x":66,"y":21.68795378729455},{"x":50,"y":24.205362968126693},{"x":16,"y":29.66484917322189},{"x":79,"y":65.41788949692858},{"x":77,"y":21.18622247994025},{"x":75,"y":36.45458971198739},{"x":69,"y":36.65637480991869},{"x":32,"y":17.87841386180677},{"x":26,"y":17.108939291329797},{"x":18,"y":21.87002506211168},{"x":81,"y":23.153336112935076},{"x":92,"y":25.17232534348622},{"x":36,"y":16.248616696962983},{"x":73,"y":23.87103713054221},{"x":86,"y":19.879141878203633},{"x":20,"y":37.46515220071606},{"x":47,"y":19.090790953914276},{"x":82,"y":26.89320302407518},{"x":67,"y":16.117789717016066},{"x":60,"y":22.32063886109512},{"x":48,"y":15.916272723767682},{"x":75,"y":28.020440068878155},{"x":77,"y":29.36049852628517},{"x":87,"y":24.76808296690137},{"x":28,"y":31.84614195703628},{"x":61,"y":36.35493653686531},{"x":18,"y":25.29204298102541},{"x":33,"y":17.593989983396767},{"x":23,"y":40.121650418861755},{"x":6,"y":19.761297676662853},{"x":94,"y":48.80713246209156},{"x":88,"y":16.038906960647008},{"x":86,"y":29.948695104163413},{"x":30,"y":19.86298817754459},{"x":24,"y":19.47156489663052},{"x":32,"y":30.16884289858895},{"x":69,"y":30.763879444031332},{"x":72,"y":26.300970575084513},{"x":21,"y":17.11008250667741}]}],"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50}},"value":"#gorilla_repl.vega.VegaView{:content {:axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"b0822090-f487-4c21-9383-37338f5835e0\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"b0822090-f487-4c21-9383-37338f5835e0\", :field \"data.y\"}}], :marks [{:type \"symbol\", :from {:data \"b0822090-f487-4c21-9383-37338f5835e0\"}, :properties {:enter {:x {:field \"data.x\", :scale \"x\"}, :y {:field \"data.y\", :scale \"y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}}], :data [{:name \"b0822090-f487-4c21-9383-37338f5835e0\", :values ({:x 25, :y 25.046187131967198} {:x 26, :y 19.177480607460254} {:x 60, :y 22.020183085175287} {:x 68, :y 23.542881758987544} {:x 77, :y 29.873773905092996} {:x 40, :y 29.435168900590526} {:x 52, :y 17.85466689923243} {:x 62, :y 20.57385469398166} {:x 55, :y 19.565803502681632} {:x 33, :y 15.194638284415097} {:x 71, :y 24.944867408723194} {:x 1, :y 24.301955126840575} {:x 43, :y 28.330625447682593} {:x 60, :y 24.6125727118996} {:x 57, :y 29.752424136964425} {:x 62, :y 40.86703453767188} {:x 49, :y 18.954004448695944} {:x 70, :y 26.705362612506658} {:x 51, :y 31.946951235030465} {:x 8, :y 24.66512520792789} {:x 16, :y 26.71588338988585} {:x 58, :y 38.08841008989284} {:x 1, :y 24.430473122357625} {:x 1, :y 24.420236235714043} {:x 94, :y 27.164164427843232} {:x 76, :y 28.526375709964668} {:x 77, :y 17.364629230226566} {:x 81, :y 30.06513564247807} {:x 28, :y 21.740602435009855} {:x 43, :y 21.139116580288277} {:x 40, :y 31.914848995951683} {:x 53, :y 27.336344401066096} {:x 17, :y 17.89677529711414} {:x 61, :y 34.109102985715346} {:x 62, :y 70.73389176539517} {:x 53, :y 18.63235669745532} {:x 16, :y 19.097877660659936} {:x 30, :y 16.59110416336605} {:x 40, :y 25.81523196463841} {:x 83, :y 32.079240710585914} {:x 27, :y 21.89898523202033} {:x 66, :y 21.68795378729455} {:x 50, :y 24.205362968126693} {:x 16, :y 29.66484917322189} {:x 79, :y 65.41788949692858} {:x 77, :y 21.18622247994025} {:x 75, :y 36.45458971198739} {:x 69, :y 36.65637480991869} {:x 32, :y 17.87841386180677} {:x 26, :y 17.108939291329797} {:x 18, :y 21.87002506211168} {:x 81, :y 23.153336112935076} {:x 92, :y 25.17232534348622} {:x 36, :y 16.248616696962983} {:x 73, :y 23.87103713054221} {:x 86, :y 19.879141878203633} {:x 20, :y 37.46515220071606} {:x 47, :y 19.090790953914276} {:x 82, :y 26.89320302407518} {:x 67, :y 16.117789717016066} {:x 60, :y 22.32063886109512} {:x 48, :y 15.916272723767682} {:x 75, :y 28.020440068878155} {:x 77, :y 29.36049852628517} {:x 87, :y 24.76808296690137} {:x 28, :y 31.84614195703628} {:x 61, :y 36.35493653686531} {:x 18, :y 25.29204298102541} {:x 33, :y 17.593989983396767} {:x 23, :y 40.121650418861755} {:x 6, :y 19.761297676662853} {:x 94, :y 48.80713246209156} {:x 88, :y 16.038906960647008} {:x 86, :y 29.948695104163413} {:x 30, :y 19.86298817754459} {:x 24, :y 19.47156489663052} {:x 32, :y 30.16884289858895} {:x 69, :y 30.763879444031332} {:x 72, :y 26.300970575084513} {:x 21, :y 17.11008250667741})}], :width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}}}"}
;; <=

;; **
;;; As can be seen there is no correlation between the archive size and the average error - albeit the number of generations was short.
;;; 
;; **
